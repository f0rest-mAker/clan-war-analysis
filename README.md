# Clash of Clans clan war data pipeline

Проект предназначен для автоматизированного сбора, обработки и хранения статистики клановых войн Clash of Clans. Система использует **Apache Airflow** для оркестрации процессов и **PostgreSQL** в качестве целевого хранилища данных.

---

## Архитектура базы данных (DDS слой)

Данные организованы по принципу многомерного моделирования в схеме `dds`. Это позволяет эффективно строить аналитические отчеты по игрокам, кланам и результатам сражений.

### Таблицы измерений (Dimensions)

* **`dds.dim_clans`**: Хранит информацию о кланах. Используется подход **SCD2** (Slowly Changing Dimensions) для отслеживания изменений уровня или названия клана во времени через поля `active_from`, `active_to` и `is_current`.
* **`dds.dim_players`**: Содержит данные об игроках, включая историю их переходов между кланами и изменения уровня ратуши.
* **`dds.dim_war_participants`**: Таблица связей, определяющая участие конкретных игроков в конкретных войнах и их позицию на карте (`map_position`).

### Таблицы фактов (Facts)

* **`dds.fact_wars`**: Основная таблица с результатами войн. Содержит агрегаты: общее количество звезд, процент разрушения и флаги результата (`is_allay_winner`, `is_draw`). Включает вычисляемые поля, такие как `war_duration_minutes` и `total_attacks`.
* **`dds.fact_attacks`**: Детальная информация по каждой атаке. Позволяет анализировать эффективность игроков через показатели `stars`, `percentage` и длительность атаки. Содержит флаги `is_triple` и `is_failed` для быстрой фильтрации результатов.

---

## Логика работы Airflow DAG (`clan_war_dag.py`)

DAG реализует полный цикл ETL-процесса и обладает механизмом само-пролонгации.

### 1. Авторизация и безопасность
* **Управление IP**: Задача `get_current_ip` определяет текущий адрес сервера.
* **Динамические токены**: Задача `login_and_generate_a_token` проверяет наличие ключа API для текущего IP в панели разработчика. Если ключ отсутствует, старые ключи аннулируются, и создается новый временный токен.

### 2. Извлечение и обработка (ETL)
* **Fetch**: Получение актуального состояния войны в формате JSON через официальный API.
* **Transformation**: Если война завершена (`warEnded`), данные парсятся в специализированные CSV-файлы для каждой сущности (кланы, игроки, войны, атаки).
* **Loading**: Данные загружаются в базу, после чего вызываются SQL-процедуры (например, `dds.load_dim_players()`) для обновления аналитического слоя.

### 3. Интеллектуальное планирование (Scheduling)
Вместо фиксированного расписания DAG использует логику на основе статуса войны:
* **Нет войны**: Повторная проверка через 12 часов.
* **Война идет**: Расчет точного времени окончания (`endTime`) и планирование запуска через 1 минуту после завершения.
* **Война окончена**: Обработка данных и планирование следующего цикла через 24 часа.

---

## Визуализация в Apache Superset

Благодаря структуре данных в слое `dds`, Apache Superset позволяет создавать детализированные дашборды для анализа эффективности клана.

---
## Требования
* **Airflow Variables**: Необходимы переменные `email` и `password` для доступа к аккаунту разработчика CoC.
* **Connections**: Требуется подключение `clan_war_db` (PostgreSQL).